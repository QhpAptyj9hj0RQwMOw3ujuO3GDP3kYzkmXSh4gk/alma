#!/usr/bin/env perl6
use v6;
use _007;

sub parse_007($program) {
    my $runtime = _007.runtime;
    my $ast = _007.parser(:$runtime).parse($program, :unexpanded);
    say htmlify($ast);
}

multi MAIN($path) {
    parse_007(slurp($path));
}

multi MAIN(Str :e($program)!) {
    parse_007($program);
}

sub aname($attr) { $attr.name.substr(2) }
sub avalue($attr, $obj) { $attr.get_value($obj) }

my %*stringification-seen;

sub htmlify($node) {
    my @attrs = $node.attributes;
    if @attrs == 1 {
        return "{$node.^name} { avalue(@attrs[0], $node).quoted-Str }";
    }
    sub keyvalue($attr) { aname($attr) ~ ": " ~ avalue($attr, $node).quoted-Str }
    my $contents = @attrs.map(&keyvalue).join(",\n").indent(4);
    return "{$node.^name} \{\n$contents\n\}";
}
